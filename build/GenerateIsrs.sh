#!/usr/bin/bash

set -e

if [ $# -le 0 ]; then
  echo "Usage: GenerateIsrs.sh <Cfile.c> <ASMFile.inc>"
  exit 1
fi

ISR_GEN_C=$1
ISR_GEN_ASM=$2

ISR_ERROR_CODES="8 10 11 12 13 14 17 21 29 30"

# C
echo "// Autogenerated isr file from build/GenerateIsrs.sh" > $ISR_GEN_C
echo "#include \"idt.h\"" >> $ISR_GEN_C
echo "#include \"gdt.h\"" >> $ISR_GEN_C
echo "" >> $ISR_GEN_C

for i in $(seq 0 255); do
    echo "void __attribute((cdecl)) i686_ISR${i}();" >> $ISR_GEN_C
done

echo "" >> $ISR_GEN_C
echo "void i686_ISRInitializeGates()" >> $ISR_GEN_C
echo "{" >> $ISR_GEN_C

for i in $(seq 0 255); do
    echo "    i686_IDTSetGate(${i}, i686_ISR${i}, i686_GDT_CODE_SEGMENT, IDT_FLAG_RING0 | IDT_FLAG_GATE_32BIT_INT);" >> $ISR_GEN_C
done
echo "}" >> $ISR_GEN_C


# ASM


echo "; Autogenerated isr file from build/GenerateIsrs.sh"
for i in $(seq 0 255); do
    if echo "$ISR_ERROR_CODES" | grep -q "\b${i}\b"; then
        echo "ISR_ERRORCODE ${i}" >> $ISR_GEN_ASM
    else
        echo "ISR_NOERRORCODE ${i}" >> $ISR_GEN_ASM
    fi
done
